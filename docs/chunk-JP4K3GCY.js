import{C as a,D as g,H as y,I as m,P as s,Q as r,R as I,U as w,V as C,W as S,c as n,ga as b,ha as j,ia as P,k,l as v,la as M,ma as p,n as l,p as h,pa as _,q as T,x as D}from"./chunk-67T6QZC4.js";var f={production:!1,googleClientID:"640802354587-81m5l0ol9b3mtmnvvuokt36v6ns3r1e2.apps.googleusercontent.com",sheetID:"1WLDvpfjkms3SpgyLgUEN4NqLVljPvxjryjpWW1sIX8w"};var d=(()=>{class e{constructor(o,t){this.zone=o,this.router=t,this.idToken=null,this.accessToken=null,this.userProfile=null,this.tokenKey="accessToken",this.idTokenKey="idToken",this.profileKey="userProfile",this.idToken=localStorage.getItem(this.idTokenKey),this.accessToken=localStorage.getItem(this.tokenKey);let i=localStorage.getItem(this.profileKey);i&&(this.userProfile=JSON.parse(i))}initGoogleSignIn(o){google.accounts.id.initialize({client_id:f.googleClientID,callback:t=>{this.zone.run(()=>{this.idToken=t.credential,this.decodeToken(),localStorage.setItem(this.idTokenKey,this.idToken),localStorage.setItem(this.profileKey,JSON.stringify(this.userProfile)),this.initTokenClient(o)})}})}renderButton(o){google.accounts.id.renderButton(document.getElementById(o),{theme:"outline",size:"large"})}initTokenClient(o){this.tokenClient=google.accounts.oauth2.initTokenClient({client_id:f.googleClientID,scope:"https://www.googleapis.com/auth/spreadsheets",hint:this.userProfile?.email,callback:t=>{this.zone.run(()=>{t?.access_token&&(this.accessToken=t.access_token,this.accessToken&&localStorage.setItem(this.tokenKey,this.accessToken)),o()})}}),this.accessToken||this.tokenClient.requestAccessToken({prompt:""})}decodeToken(){if(!this.idToken)return;let t=this.idToken.split(".")[1].replace(/-/g,"+").replace(/_/g,"/"),i=JSON.parse(window.atob(t));this.userProfile=i}getUserProfile(){return this.userProfile}getAccessToken(){return this.accessToken}isLoggedIn(){return!!this.accessToken}signOut(){this.idToken=null,this.accessToken=null,this.userProfile=null,localStorage.removeItem(this.tokenKey),localStorage.removeItem(this.idTokenKey),localStorage.removeItem(this.profileKey),this.router.navigate(["/parking/login"])}fetchSheetData(o){return n(this,null,function*(){yield this.ensureAccessToken();let t=`https://sheets.googleapis.com/v4/spreadsheets/${f.sheetID}/values/${encodeURIComponent(o)}`,i=yield fetch(t,{headers:{Authorization:`Bearer ${this.accessToken}`,Accept:"application/json"}});if((i.status===401||i.status===403)&&(yield this.requestNewAccessToken(),i=yield fetch(t,{headers:{Authorization:`Bearer ${this.accessToken}`,Accept:"application/json"}})),!i.ok){let $=yield i.text();throw new Error(`Failed to fetch sheet data (${i.status}): ${$}`)}return(yield i.json()).values||[]})}ensureAccessToken(){return n(this,null,function*(){if(!this.accessToken){if(!this.tokenClient)throw new Error("Not authenticated. Please sign in first.");yield this.requestNewAccessToken()}})}requestNewAccessToken(){return new Promise((o,t)=>{try{this.tokenClient.callback=i=>{this.zone.run(()=>{i?.access_token?(this.accessToken=i.access_token,this.accessToken&&localStorage.setItem(this.tokenKey,this.accessToken),o()):t(new Error("Failed to obtain access token"))})},this.tokenClient.requestAccessToken({prompt:""})}catch(i){t(i)}})}static{this.\u0275fac=function(t){return new(t||e)(l(D),l(p))}}static{this.\u0275prov=k({token:e,factory:e.\u0275fac,providedIn:"root"})}}return e})();function z(e,c){e&1&&(s(0,"div"),C(1,"Loading..."),r())}function B(e,c){if(e&1&&(s(0,"div",3),C(1),r()),e&2){let o=w();a(),S(o.error)}}function L(e,c){if(e&1&&(s(0,"td"),C(1),r()),e&2){let o=c.$implicit;a(),S(o)}}function U(e,c){if(e&1&&(s(0,"tr"),y(1,L,2,1,"td",5),r()),e&2){let o=c.$implicit;a(),m("ngForOf",o)}}function R(e,c){if(e&1&&(s(0,"table",4),y(1,U,2,1,"tr",5),r()),e&2){let o=w();a(),m("ngForOf",o.rows)}}var N=(()=>{class e{constructor(o){this.auth=o,this.rows=[],this.loading=!0,this.error=null}ngOnInit(){return n(this,null,function*(){try{this.rows=yield this.auth.fetchSheetData("Sheet1!A1:E20")}catch(o){this.error=o.message}finally{this.loading=!1}})}static{this.\u0275fac=function(t){return new(t||e)(g(d))}}static{this.\u0275cmp=h({type:e,selectors:[["saoa-dash"]],decls:3,vars:3,consts:[[4,"ngIf"],["class","text-danger",4,"ngIf"],["class","table table-bordered",4,"ngIf"],[1,"text-danger"],[1,"table","table-bordered"],[4,"ngFor","ngForOf"]],template:function(t,i){t&1&&y(0,z,2,0,"div",0)(1,B,2,1,"div",1)(2,R,2,1,"table",2),t&2&&(m("ngIf",i.loading),a(),m("ngIf",i.error),a(),m("ngIf",i.rows.length))},dependencies:[b,j]})}}return e})();var F=(()=>{class e{constructor(o,t){this.authService=o,this.router=t}ngOnInit(){this.authService.initGoogleSignIn(()=>n(this,null,function*(){console.log("User profile:",this.authService.getUserProfile()),(yield this.checkSheetAccess())?this.router.navigateByUrl("/parking/dash"):alert("You do not have access to this sheet.")})),this.authService.renderButton("g_id_signin")}checkSheetAccess(){return n(this,null,function*(){let o=this.authService.getAccessToken();if(!o)return!1;try{let t=f.sheetID;return(yield fetch(`https://sheets.googleapis.com/v4/spreadsheets/${t}`,{headers:{Authorization:`Bearer ${o}`}})).ok}catch(t){return console.error("Error checking sheet access",t),!1}})}static{this.\u0275fac=function(t){return new(t||e)(g(d),g(p))}}static{this.\u0275cmp=h({type:e,selectors:[["saoa-login"]],decls:2,vars:0,consts:[[1,"d-flex","justify-content-center","mt-5"],["id","g_id_signin"]],template:function(t,i){t&1&&(s(0,"div",0),I(1,"div",1),r())},encapsulation:2})}}return e})();var E=(()=>{class e{constructor(o,t){this.auth=o,this.router=t}canActivate(){return this.auth.getAccessToken()?!0:(this.router.navigateByUrl("/parking/login"),!1)}static{this.\u0275fac=function(t){return new(t||e)(l(d),l(p))}}static{this.\u0275prov=k({token:e,factory:e.\u0275fac,providedIn:"root"})}}return e})();var K=(()=>{class e{static{this.\u0275fac=function(t){return new(t||e)}}static{this.\u0275cmp=h({type:e,selectors:[["saoa-parking"]],decls:1,vars:0,template:function(t,i){t&1&&I(0,"router-outlet")},dependencies:[M]})}}return e})();var q=[{path:"",component:K,children:[{path:"",redirectTo:"dash",pathMatch:"full"},{path:"login",component:F},{path:"dash",canActivate:[E],component:N}]}],O=(()=>{class e{static{this.\u0275fac=function(t){return new(t||e)}}static{this.\u0275mod=T({type:e})}static{this.\u0275inj=v({imports:[_.forChild(q),_]})}}return e})();var ke=(()=>{class e{static{this.\u0275fac=function(t){return new(t||e)}}static{this.\u0275mod=T({type:e})}static{this.\u0275inj=v({imports:[P,O]})}}return e})();export{ke as ParkingModule};
