import{C as a,F as f,G as h,H as v,M as T,N as y,P as w,Q as S,R as _,T as s,U as r,V as C,Y as x,c as n,ca as I,da as A,k as g,l as k,n as l,oa as M,ra as N,sa as m,t as b,va as D}from"./chunk-TKEAQERG.js";var p={production:!1,googleClientID:"640802354587-81m5l0ol9b3mtmnvvuokt36v6ns3r1e2.apps.googleusercontent.com",sheetID:"1WLDvpfjkms3SpgyLgUEN4NqLVljPvxjryjpWW1sIX8w"};var u=(()=>{class e{constructor(i,t){this.zone=i,this.router=t,this.idToken=null,this.accessToken=null,this.userProfile=null,this.tokenKey="accessToken",this.idTokenKey="idToken",this.profileKey="userProfile",this.idToken=localStorage.getItem(this.idTokenKey),this.accessToken=localStorage.getItem(this.tokenKey);let o=localStorage.getItem(this.profileKey);o&&(this.userProfile=JSON.parse(o))}initGoogleSignIn(i){google.accounts.id.initialize({client_id:p.googleClientID,callback:t=>{this.zone.run(()=>{this.idToken=t.credential,this.decodeToken(),localStorage.setItem(this.idTokenKey,this.idToken),localStorage.setItem(this.profileKey,JSON.stringify(this.userProfile)),this.initTokenClient(i)})}})}renderButton(i){google.accounts.id.renderButton(document.getElementById(i),{theme:"outline",size:"large"})}initTokenClient(i){this.tokenClient=google.accounts.oauth2.initTokenClient({client_id:p.googleClientID,scope:"https://www.googleapis.com/auth/spreadsheets",hint:this.userProfile?.email,callback:t=>{this.zone.run(()=>{t?.access_token&&(this.accessToken=t.access_token,this.accessToken&&localStorage.setItem(this.tokenKey,this.accessToken)),i()})}}),this.accessToken||this.tokenClient.requestAccessToken({prompt:""})}decodeToken(){if(!this.idToken)return;let t=this.idToken.split(".")[1].replace(/-/g,"+").replace(/_/g,"/"),o=JSON.parse(window.atob(t));this.userProfile=o}getUserProfile(){return this.userProfile}getAccessToken(){return this.accessToken}isLoggedIn(){return!!this.accessToken}signOut(){this.idToken=null,this.accessToken=null,this.userProfile=null,localStorage.removeItem(this.tokenKey),localStorage.removeItem(this.idTokenKey),localStorage.removeItem(this.profileKey),this.router.navigate(["/parking/login"])}fetchSheetData(i){return n(this,null,function*(){yield this.ensureAccessToken();let t=`https://sheets.googleapis.com/v4/spreadsheets/${p.sheetID}/values/${encodeURIComponent(i)}`,o=yield fetch(t,{headers:{Authorization:`Bearer ${this.accessToken}`,Accept:"application/json"}});if((o.status===401||o.status===403)&&(yield this.requestNewAccessToken(),o=yield fetch(t,{headers:{Authorization:`Bearer ${this.accessToken}`,Accept:"application/json"}})),!o.ok){let z=yield o.text();throw new Error(`Failed to fetch sheet data (${o.status}): ${z}`)}return(yield o.json()).values||[]})}ensureAccessToken(){return n(this,null,function*(){if(!this.accessToken){if(!this.tokenClient)throw new Error("Not authenticated. Please sign in first.");yield this.requestNewAccessToken()}})}requestNewAccessToken(){return new Promise((i,t)=>{try{this.tokenClient.callback=o=>{this.zone.run(()=>{o?.access_token?(this.accessToken=o.access_token,this.accessToken&&localStorage.setItem(this.tokenKey,this.accessToken),i()):t(new Error("Failed to obtain access token"))})},this.tokenClient.requestAccessToken({prompt:""})}catch(o){t(o)}})}static{this.\u0275fac=function(t){return new(t||e)(l(b),l(m))}}static{this.\u0275prov=g({token:e,factory:e.\u0275fac,providedIn:"root"})}}return e})();function L(e,c){e&1&&(s(0,"div"),I(1,"Loading..."),r())}function U(e,c){if(e&1&&(s(0,"div",0),I(1),r()),e&2){let i=x();a(),A(i.error)}}function O(e,c){if(e&1&&(s(0,"td"),I(1),r()),e&2){let i=c.$implicit;a(),A(i)}}function R(e,c){if(e&1&&(s(0,"tr"),S(1,O,2,1,"td",null,w),r()),e&2){let i=c.$implicit;a(),_(i)}}function q(e,c){if(e&1&&(s(0,"table",1),S(1,R,3,0,"tr",null,w),r()),e&2){let i=x();a(),_(i.rows)}}var E=(()=>{class e{constructor(i){this.auth=i,this.rows=[],this.loading=!0,this.error=null}ngOnInit(){return n(this,null,function*(){try{this.rows=yield this.auth.fetchSheetData("Sheet1!A1:E20")}catch(i){this.error=i.message}finally{this.loading=!1}})}static{this.\u0275fac=function(t){return new(t||e)(f(u))}}static{this.\u0275cmp=h({type:e,selectors:[["saoa-dash"]],standalone:!1,decls:3,vars:3,consts:[[1,"text-danger"],[1,"table","table-bordered"]],template:function(t,o){t&1&&(T(0,L,2,0,"div"),T(1,U,2,1,"div",0),T(2,q,3,0,"table",1)),t&2&&(y(o.loading?0:-1),a(),y(o.error?1:-1),a(),y(o.rows.length?2:-1))},encapsulation:2})}}return e})();var K=(()=>{class e{constructor(i,t){this.authService=i,this.router=t}ngOnInit(){this.authService.initGoogleSignIn(()=>n(this,null,function*(){console.log("User profile:",this.authService.getUserProfile()),(yield this.checkSheetAccess())?this.router.navigateByUrl("/parking/dash"):alert("You do not have access to this sheet.")})),this.authService.renderButton("g_id_signin")}checkSheetAccess(){return n(this,null,function*(){let i=this.authService.getAccessToken();if(!i)return!1;try{let t=p.sheetID;return(yield fetch(`https://sheets.googleapis.com/v4/spreadsheets/${t}`,{headers:{Authorization:`Bearer ${i}`}})).ok}catch(t){return console.error("Error checking sheet access",t),!1}})}static{this.\u0275fac=function(t){return new(t||e)(f(u),f(m))}}static{this.\u0275cmp=h({type:e,selectors:[["saoa-login"]],standalone:!1,decls:2,vars:0,consts:[[1,"d-flex","justify-content-center","mt-5"],["id","g_id_signin"]],template:function(t,o){t&1&&(s(0,"div",0),C(1,"div",1),r())},encapsulation:2})}}return e})();var F=(()=>{class e{constructor(i,t){this.auth=i,this.router=t}canActivate(){return this.auth.getAccessToken()?!0:(this.router.navigateByUrl("/parking/login"),!1)}static{this.\u0275fac=function(t){return new(t||e)(l(u),l(m))}}static{this.\u0275prov=g({token:e,factory:e.\u0275fac,providedIn:"root"})}}return e})();var B=(()=>{class e{static{this.\u0275fac=function(t){return new(t||e)}}static{this.\u0275cmp=h({type:e,selectors:[["saoa-parking"]],standalone:!1,decls:1,vars:0,template:function(t,o){t&1&&C(0,"router-outlet")},dependencies:[N],encapsulation:2})}}return e})();var G=[{path:"",component:B,children:[{path:"",redirectTo:"dash",pathMatch:"full"},{path:"login",component:K},{path:"dash",canActivate:[F],component:E}]}],$=(()=>{class e{static{this.\u0275fac=function(t){return new(t||e)}}static{this.\u0275mod=v({type:e})}static{this.\u0275inj=k({imports:[D.forChild(G),D]})}}return e})();var ke=(()=>{class e{static{this.\u0275fac=function(t){return new(t||e)}}static{this.\u0275mod=v({type:e})}static{this.\u0275inj=k({imports:[M,$]})}}return e})();export{ke as ParkingModule};
