<div class="data-fields">
  <div style="padding-block: 1rem;">
    Please provide the information below to calculate the water billing for the block.
  </div>
  <div style="display: flex; flex-direction: column; gap: 0.25rem;">
    <div style="display: flex; flex-direction: row; gap: 0.25rem;">
      <div class="field-set">
        <input type="file" (change)="onFileChange($event)" style="max-width: 100%; width: 100%;" />
      </div>
    </div>
    <div style="display: flex; flex-direction: row; gap: 0.25rem;">
      <div class="field-set">
        <label for="ohtInput">OHT Input (Litres)</label>
        <input [(ngModel)]="ohtInput" type="number" name="ohtInput" id="ohtInput" (ngModelChange)="updateTotals()">
      </div>
      <div class="field-set">
        <label for="tankerPrice">Tanker Price (Rs.)</label>
        <input [(ngModel)]="tankerPrice" type="number" name="tankerPrice" id="tankerPrice"
          (ngModelChange)="updateTotals()">
        <small><em>on tanker is equal to 6000 ltrs.</em></small>
      </div>
      <div class="field-set">
        <label for="txtBlock">Block Name</label>
        <input [(ngModel)]="txtBlock" type="text" name="txtBlock" id="txtBlock">
      </div>
    </div>
    <div style="display: flex; flex-direction: row; gap: 0.25rem;">
      <div class="field-set">
        <label for="datePeriodFrom">Billing Period From</label>
        <input [(ngModel)]="datePeriodFrom" type="date" name="datePeriodFrom" id="datePeriodFrom">
      </div>
      <div class="field-set">
        <label for="datePeriodTo">Billing Period From</label>
        <input [(ngModel)]="datePeriodTo" type="date" name="datePeriodTo" id="datePeriodTo">
      </div>
      <div class="field-set">
        <label for="dateChagred">Charge Date</label>
        <input [(ngModel)]="dateChagred" type="date" name="dateChagred" id="dateChagred">
      </div>
      <div class="field-set">
        <label for="datePaymentLast">Last Date</label>
        <input [(ngModel)]="datePaymentLast" type="date" name="datePaymentLast" id="datePaymentLast">
      </div>
    </div>
  </div>
</div>
<div *ngIf="data">
  <div style="padding-block: 1rem; display: flex; justify-content: space-between;">
    <span>Please use the check box to use the average reading for the unit on the given date.</span>
    <div><button (click)="export()">Export</button></div>
  </div>
  <div class="scroll-area">
    <div>
      <table>
        <thead>
          <tr>
            <th>Unit Number</th>
            <th>Unit Average</th>
            <th>Metered Total</th>
            <th>Averaged Total</th>
            <th *ngIf="ohtInput">Variation</th>
            <th>Billable</th>
            <th *ngIf="tankerPrice">Billed Amount</th>
            <th *ngFor="let val of dates">
              <span>
                {{val.date}}
              </span>
              <span>
                <input type="checkbox" (click)="useAverageForDateChanged($event, val.date)" />
              </span>
            </th>
          </tr>
        </thead>
        <tbody>
          <tr *ngFor="let row of data | keyvalue; let i = index">
            <td>
              {{row.key}}
            </td>
            <td>
              {{averages[i].toLocaleString('en-IN', { minimumIntegerDigits: 1, maximumFractionDigits:2,
              minimumFractionDigits: 2 })}}
            </td>
            <td>
              {{measuredTotals[i].toLocaleString('en-IN', { minimumIntegerDigits: 1, maximumFractionDigits:2,
              minimumFractionDigits: 2 })}}
            </td>
            <td>
              {{averagedTotals[i].toLocaleString('en-IN', { minimumIntegerDigits: 1, maximumFractionDigits:2,
              minimumFractionDigits: 2 })}}
            </td>
            <td *ngIf="ohtInput">
              {{variations[i].toLocaleString('en-IN', { minimumIntegerDigits: 1, maximumFractionDigits:2,
              minimumFractionDigits: 2 })}}
            </td>
            <td>
              {{billable[i].toLocaleString('en-IN', { minimumIntegerDigits: 1, maximumFractionDigits:2,
              minimumFractionDigits: 2 })}}
            </td>
            <td *ngIf="tankerPrice">
              {{billed[i].toLocaleString('en-IN', { minimumIntegerDigits: 1, maximumFractionDigits:2,
              minimumFractionDigits: 2 })}}
            </td>
            <td *ngFor="let val of row.value" [ngClass]="{'zero': !val.reading, 'average': val.useAverage}">
              <span>
                {{(val.useAverage ? averages[i] : val.reading).toLocaleString('en-IN', { minimumIntegerDigits: 1,
                maximumFractionDigits:2, minimumFractionDigits: 2 }) }}
              </span>
              <span>
                <input type="checkbox" [checked]="val.useAverage"
                  (click)="useAverageChanged($event, row.key, val.date)" />
              </span>
            </td>
          </tr>
          <tr style="border-top: 5px double #333;">
            <td>
              <strong>Calculated Consumption:</strong>
              <br>
              <small>(Sum of Metered Totals and Averaged Totals)</small>
            </td>
            <td>
              {{calculatedConsumption.toLocaleString('en-IN', { minimumIntegerDigits: 1, maximumFractionDigits:2,
              minimumFractionDigits: 2 })}}
              <br>
              <small>(Litres)</small>
            </td>
          </tr>
          <tr *ngIf="ohtInput" style="border-top: 5px double #333;">
            <td>
              <strong>Consumption Variation:</strong>
              <br>
              <small>(OHT Input - Calculated)</small>
            </td>
            <td>
              {{(ohtInput ? ohtInput - calculatedConsumption : 0).toLocaleString('en-IN', { minimumIntegerDigits: 1,
              maximumFractionDigits:2, minimumFractionDigits: 2 })}}
              <br>
              <small>(Litres)</small>
            </td>
          </tr>
        </tbody>
      </table>
    </div>
  </div>
</div>